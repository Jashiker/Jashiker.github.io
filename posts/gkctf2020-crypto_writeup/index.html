<!DOCTYPE html>
<html lang="en"><head>
    <title>OPdbg</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://OolongCode.github.io/favicon.ico">
    <link rel="canonical" href="https://OolongCode.github.io">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://OolongCode.github.io">OPdbg</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>About</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/posts">
                                    
                                    <span>All posts</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/tags">
                                    
                                    <span>Tags</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/link">
                                    
                                    <span>Link</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>GKCTF2020 CRYPTO_writeup - Sat, Jun 26, 2021</h1>
    </div>
    <p class="lead"></p>
    <p>GKCTF2020的密码学题目相对而言比较简单，古典密码学题目偏多。而且密码学题目也只有四道题目</p>
<p><img src="/images/GKCTF2020-Crypto_writeup/WechatIMG1350.jpeg" alt="img"></p>
<h2 id="0x0-小学生的密码学">0x0 小学生的密码学</h2>
<p>打开题目描述，查看题目描述内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">e(x)=11x+6(mod26)

密文：welcylk

（flag为base64形式）
</code></pre></div><p>看样子是仿射密码，直接逆就好了，写个python脚本解决吧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> gmpy2
<span style="color:#f92672">import</span> string
<span style="color:#f92672">import</span> base64

m <span style="color:#f92672">=</span> gmpy2<span style="color:#f92672">.</span>invert(<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">26</span>)

table <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_lowercase
<span style="color:#75715e"># print table</span>
cipher <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;welcylk&#34;</span>
plainer <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> cipher:
    x <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>index(i)
    j <span style="color:#f92672">=</span> (x<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>)<span style="color:#f92672">*</span>m <span style="color:#f92672">%</span><span style="color:#ae81ff">26</span>
<span style="color:#75715e">#    print j</span>
    plainer <span style="color:#f92672">+=</span> table[j]

flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flag{&#34;</span><span style="color:#f92672">+</span>base64<span style="color:#f92672">.</span>b64encode(plainer) <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;}&#34;</span>
print flag
</code></pre></div><p>运行脚本，得到flag：</p>
<pre tabindex="0"><code>flag{c29yY2VyeQ==}
</code></pre><h2 id="0x1-汉字的秘密">0x1 汉字的秘密</h2>
<p>题目描述：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">你能看出汉字的奥秘吗？ 答案形式：flag{小写字母}
</code></pre></div><p>和汉字相关的密码，又是考察古典密码，估计是当铺密码</p>
<p>下载附件，发现附件是一个doc文件，查看附件内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">王壮 夫工 王中 王夫 由由井 井人 夫中 夫夫 井王 土土 夫由
土夫 井中 士夫 王工 王人 土由 由口夫
</code></pre></div><p>看样子是当铺密码，没错了，写个脚本处理一下吧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">dh <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;田口由中人工大土士王夫井羊壮&#39;</span>
ds <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;00123455567899&#39;</span>

c <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;王壮 夫工 王中 王夫 由由井 井人 夫中 夫夫 井王 土土 夫由 土夫 井中 士夫 王工 王人 土由 由口夫&#39;</span>
s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> c:
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">in</span> dh:
        s <span style="color:#f92672">+=</span> ds[dh<span style="color:#f92672">.</span>index(i)]
    <span style="color:#66d9ef">else</span>:
        s <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39; &#39;</span>
<span style="color:#75715e">#print(s)</span>

c_list <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34; &#34;</span>)
m <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,len(c_list)):
    m <span style="color:#f92672">+=</span> chr(int(c_list[i])<span style="color:#f92672">+</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)

flag <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>lower()
print(flag)
</code></pre></div><p>运行脚本，得到flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{you_are_good}
</code></pre></div><hr>
<p>那什么是当铺密码呢？</p>
<p>当铺密码是一种很有意思的密码，专门用来加密数字的，不需要密钥，明文信息包含在加密后的密文中。</p>
<p>它通过一个汉字中隐藏的信息：笔画数，来将汉字和数字关联起来，将汉字定义为明文，将数字定义为密文，加密是将数字映射到对应笔画的汉字，解密是将汉字按照笔画映射回数字。</p>
<p>有很多汉字的笔画数是相同的，所以可能会有多个明文（汉字）对应同一个密文（数字），当然这个主要是看汉字笔画映射表的选择，如果映射表只准备了9个汉字，每种笔画有一个汉字对应则是一对一的，否则是一对多的。一对一的话有个缺点就是如果要加密的明文中有重复数字，比如33，转换为“飞马”比“三三”更难总结出规律，而这种没有秘钥的加密方式重要的就是隐藏自己的规律，所以一对多会更难被破译。[1]</p>
<p>当铺密码就是根据汉字的特点来设计的一种古典密码，还是挺有意思的，虽然不是很实用。</p>
<h2 id="0x2-babycrypto">0x2 babycrypto</h2>
<p>下载附件，查看附件内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># n:0xb119849bc4523e49c6c038a509a74cda628d4ca0e4d0f28e677d57f3c3c7d0d876ef07d7581fe05a060546fedd7d061d3bc70d679b6c5dd9bc66c5bdad8f2ef898b1e785496c4989daf716a1c89d5c174da494eee7061bcb6d52cafa337fc2a7bba42c918bbd3104dff62ecc9d3704a455a6ce282de0d8129e26c840734ffd302bec5f0a66e0e6d00b5c50fa57c546cff9d7e6a978db77997082b4cb927df9847dfffef55138cb946c62c9f09b968033745b5b6868338c64819a8e92a827265f9abd409359a9471d8c3a2631b80e5b462ba42336717700998ff38536c2436e24ac19228cd2d7a909ead1a8494ff6c3a7151e888e115b68cc6a7a8c6cf8a6c005L
# e:65537
# enc:1422566584480199878714663051468143513667934216213366733442059106529451931078271460363335887054199577950679102659270179475911101747625120544429262334214483688332111552004535828182425152965223599160129610990036911146029170033592055768983427904835395850414634659565092191460875900237711597421272312032796440948509724492027247376113218678183443222364531669985128032971256792532015051829041230203814090194611041172775368357197854451201260927117792277559690205342515437625417792867692280849139537687763919269337822899746924269847694138899165820004160319118749298031065800530869562704671435709578921901495688124042302500361
# p&gt;&gt;128&lt;&lt;128:0xe4e4b390c1d201dae2c00a4669c0865cc5767bc444f5d310f3cfc75872d96feb89e556972c99ae20753e3314240a52df5dccd076a47c6b5d11b531b92d901b2b512aeb0b263bbfd624fe3d52e5e238beeb581ebe012b2f176a4ffd1e0d2aa8c4d3a2656573b727d4d3136513a931428b00000000000000000000000000000000L
</code></pre></div><p>RSA题目，考察的应该是p的高位泄露，应该是针对p的高位泄露进行设计的攻击算法来进行求解的。经查询发现，coppersmith算法应该是就是解决p高位泄露问题的解密算法，但是这个算法需要使用的开源数学工具sagemath。这里采用sagemath程序解决：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb119849bc4523e49c6c038a509a74cda628d4ca0e4d0f28e677d57f3c3c7d0d876ef07d7581fe05a060546fedd7d061d3bc70d679b6c5dd9bc66c5bdad8f2ef898b1e785496c4989daf716a1c89d5c174da494eee7061bcb6d52cafa337fc2a7bba42c918bbd3104dff62ecc9d3704a455a6ce282de0d8129e26c840734ffd302bec5f0a66e0e6d00b5c50fa57c546cff9d7e6a978db77997082b4cb927df9847dfffef55138cb946c62c9f09b968033745b5b6868338c64819a8e92a827265f9abd409359a9471d8c3a2631b80e5b462ba42336717700998ff38536c2436e24ac19228cd2d7a909ead1a8494ff6c3a7151e888e115b68cc6a7a8c6cf8a6c005</span>L
p_fake <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe4e4b390c1d201dae2c00a4669c0865cc5767bc444f5d310f3cfc75872d96feb89e556972c99ae20753e3314240a52df5dccd076a47c6b5d11b531b92d901b2b512aeb0b263bbfd624fe3d52e5e238beeb581ebe012b2f176a4ffd1e0d2aa8c4d3a2656573b727d4d3136513a931428b00000000000000000000000000000000</span>L
pbits <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
kbits <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
pbar <span style="color:#f92672">=</span> p_fake <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span>pbits<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">^</span>kbits)
print(<span style="color:#e6db74">&#34;upper </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> bits (of </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> bits) is given&#34;</span> <span style="color:#f92672">%</span> (pbits<span style="color:#f92672">-</span>kbits, pbits))
PR<span style="color:#f92672">.&lt;</span>x<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> PolynomialRing(Zmod(n))
f <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> pbar
x0 <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>small_roots(X<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#f92672">^</span>kbits, beta<span style="color:#f92672">=</span><span style="color:#ae81ff">0.4</span>)[<span style="color:#ae81ff">0</span>]
print(hex(int(x0 <span style="color:#f92672">+</span> pbar)))
</code></pre></div><p>使用sagemath运行可以得到p的数值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">0xe4e4b390c1d201dae2c00a4669c0865cc5767bc444f5d310f3cfc75872d96feb89e556972c99ae20753e3314240a52df5dccd076a47c6b5d11b531b92d901b2b512aeb0b263bbfd624fe3d52e5e238beeb581ebe012b2f176a4ffd1e0d2aa8c4d3a2656573b727d4d3136513a931428b92826225b6d0e735440b613a8336ffa3
</code></pre></div><p>然后再使用一常规的RSA脚本进行求解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> libnum

n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb119849bc4523e49c6c038a509a74cda628d4ca0e4d0f28e677d57f3c3c7d0d876ef07d7581fe05a060546fedd7d061d3bc70d679b6c5dd9bc66c5bdad8f2ef898b1e785496c4989daf716a1c89d5c174da494eee7061bcb6d52cafa337fc2a7bba42c918bbd3104dff62ecc9d3704a455a6ce282de0d8129e26c840734ffd302bec5f0a66e0e6d00b5c50fa57c546cff9d7e6a978db77997082b4cb927df9847dfffef55138cb946c62c9f09b968033745b5b6868338c64819a8e92a827265f9abd409359a9471d8c3a2631b80e5b462ba42336717700998ff38536c2436e24ac19228cd2d7a909ead1a8494ff6c3a7151e888e115b68cc6a7a8c6cf8a6c005</span>L
e <span style="color:#f92672">=</span> <span style="color:#ae81ff">65537</span>
c <span style="color:#f92672">=</span> <span style="color:#ae81ff">1422566584480199878714663051468143513667934216213366733442059106529451931078271460363335887054199577950679102659270179475911101747625120544429262334214483688332111552004535828182425152965223599160129610990036911146029170033592055768983427904835395850414634659565092191460875900237711597421272312032796440948509724492027247376113218678183443222364531669985128032971256792532015051829041230203814090194611041172775368357197854451201260927117792277559690205342515437625417792867692280849139537687763919269337822899746924269847694138899165820004160319118749298031065800530869562704671435709578921901495688124042302500361</span>
p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe4e4b390c1d201dae2c00a4669c0865cc5767bc444f5d310f3cfc75872d96feb89e556972c99ae20753e3314240a52df5dccd076a47c6b5d11b531b92d901b2b512aeb0b263bbfd624fe3d52e5e238beeb581ebe012b2f176a4ffd1e0d2aa8c4d3a2656573b727d4d3136513a931428b92826225b6d0e735440b613a8336ffa3</span>
q <span style="color:#f92672">=</span> n <span style="color:#f92672">//</span> p
phi <span style="color:#f92672">=</span> (p<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>(q<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
d <span style="color:#f92672">=</span> libnum<span style="color:#f92672">.</span>invmod(e,phi)
m <span style="color:#f92672">=</span> pow(c,d,n)
flag <span style="color:#f92672">=</span> libnum<span style="color:#f92672">.</span>n2s(m)
print flag
</code></pre></div><p>运行脚本，得到flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{3d0914a1-1e97-4822-a745-c7e20c5179b9}
</code></pre></div><h2 id="0x3-backdoor">0x3 Backdoor</h2>
<p>查看题目描述：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">p=k*M+(65537**a %M)
</code></pre></div><p>根据题目描述可以联想到ROCA漏洞，可以从论文中清晰地看到：</p>
<p><a href="/images/GKCTF2020-Crypto_writeup/image-12.png"><img src="/images/GKCTF2020-Crypto_writeup/image-12.png" alt="img"></a></p>
<p>正好符合这个题目的hint，这个题目的考察要点应该就是<a href="https://crocs.fi.muni.cz/public/papers/rsa_ccs17">ROCA的CVE漏洞</a>。这个CVE的利用再GitHub上面有现成的轮子，进行稍微修改一下就可以使用，这里给出解题的sagemath exp：[2]</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">param <span style="color:#f92672">=</span> 
{
  <span style="color:#ae81ff">512</span>: {
    <span style="color:#e6db74">&#34;n&#34;</span>: <span style="color:#ae81ff">39</span>,
    <span style="color:#e6db74">&#34;a_max&#34;</span>: <span style="color:#ae81ff">62</span>,
    <span style="color:#e6db74">&#34;k_max&#34;</span>: <span style="color:#ae81ff">37</span>,
    <span style="color:#e6db74">&#34;M&#34;</span>: <span style="color:#ae81ff">0x924cba6ae99dfa084537facc54948df0c23da044d8cabe0edd75bc6</span>,
    <span style="color:#e6db74">&#34;M_prime&#34;</span>: <span style="color:#ae81ff">0x1b3e6c9433a7735fa5fc479ffe4027e13bea</span>,
    <span style="color:#e6db74">&#34;m&#34;</span>: <span style="color:#ae81ff">5</span>,
    <span style="color:#e6db74">&#34;t&#34;</span>: <span style="color:#ae81ff">6</span>,
    <span style="color:#e6db74">&#34;c_a&#34;</span>: <span style="color:#ae81ff">0x80000</span>
  },
  <span style="color:#ae81ff">1024</span>: {
    <span style="color:#e6db74">&#34;n&#34;</span>: <span style="color:#ae81ff">71</span>,
    <span style="color:#e6db74">&#34;a_max&#34;</span>: <span style="color:#ae81ff">134</span>,
    <span style="color:#e6db74">&#34;k_max&#34;</span>: <span style="color:#ae81ff">37</span>,
    <span style="color:#e6db74">&#34;M&#34;</span>: <span style="color:#ae81ff">0x7923ba25d1263232812ac930e9683ac0b02180c32bae1d77aa950c4a18a4e660db8cc90384a394940593408f192de1a05e1b61673ac499416088382</span>,
    <span style="color:#e6db74">&#34;M_prime&#34;</span>: <span style="color:#ae81ff">0x24683144f41188c2b1d6a217f81f12888e4e6513c43f3f60e72af8bd9728807483425d1e</span>,
    <span style="color:#e6db74">&#34;m&#34;</span>: <span style="color:#ae81ff">4</span>,
    <span style="color:#e6db74">&#34;t&#34;</span>: <span style="color:#ae81ff">5</span>,
    <span style="color:#e6db74">&#34;c_a&#34;</span>: <span style="color:#ae81ff">0x40000000</span>
  },
  <span style="color:#ae81ff">2048</span>: {
    <span style="color:#e6db74">&#34;n&#34;</span>: <span style="color:#ae81ff">126</span>,
    <span style="color:#e6db74">&#34;a_max&#34;</span>: <span style="color:#ae81ff">434</span>,
    <span style="color:#e6db74">&#34;k_max&#34;</span>: <span style="color:#ae81ff">53</span>,
    <span style="color:#e6db74">&#34;M&#34;</span>: <span style="color:#ae81ff">0x7cda79f57f60a9b65478052f383ad7dadb714b4f4ac069997c7ff23d34d075fca08fdf20f95fbc5f0a981d65c3a3ee7ff74d769da52e948d6b0270dd736ef61fa99a54f80fb22091b055885dc22b9f17562778dfb2aeac87f51de339f71731d207c0af3244d35129feba028a48402247f4ba1d2b6d0755baff6</span>,
    <span style="color:#e6db74">&#34;M_prime&#34;</span>: <span style="color:#ae81ff">0x16928dc3e47b44daf289a60e80e1fc6bd7648d7ef60d1890f3e0a9455efe0abdb7a748131413cebd2e36a76a355c1b664be462e115ac330f9c13344f8f3d1034a02c23396e6</span>,
    <span style="color:#e6db74">&#34;m&#34;</span>: <span style="color:#ae81ff">7</span>,
    <span style="color:#e6db74">&#34;t&#34;</span>: <span style="color:#ae81ff">8</span>,
    <span style="color:#e6db74">&#34;c_a&#34;</span>: <span style="color:#ae81ff">0x400000000</span>
  }
}

<span style="color:#75715e"># https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/coppersmith.sage</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">coppersmith_howgrave_univariate</span>(pol, N, beta, mm, tt, XX):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Coppersmith revisited by Howgrave-Graham
</span><span style="color:#e6db74">    
</span><span style="color:#e6db74">    finds a solution if:
</span><span style="color:#e6db74">    * b|N, b &gt;= N^beta , 0 &lt; beta &lt;= 1
</span><span style="color:#e6db74">    * |x| &lt; XX
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#75715e">#</span>
    <span style="color:#75715e"># init</span>
    <span style="color:#75715e">#</span>
    dd <span style="color:#f92672">=</span> pol<span style="color:#f92672">.</span>degree()
    nn <span style="color:#f92672">=</span> dd <span style="color:#f92672">*</span> mm <span style="color:#f92672">+</span> tt
    
    <span style="color:#75715e">#</span>
    <span style="color:#75715e"># checks</span>
    <span style="color:#75715e">#</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;</span> beta <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> :
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;beta should belongs in (0, 1]&#34;</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> pol<span style="color:#f92672">.</span>is_monic():
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ArithmeticError</span>(<span style="color:#e6db74">&#34;Polynomial must be monic.&#34;</span>)

    
    <span style="color:#75715e">#</span>
    <span style="color:#75715e"># Coppersmith revisited algo for univariate</span>
    <span style="color:#75715e">#</span>

    <span style="color:#75715e"># change ring of pol and x</span>
    polZ <span style="color:#f92672">=</span> pol<span style="color:#f92672">.</span>change_ring(ZZ)
    x <span style="color:#f92672">=</span> polZ<span style="color:#f92672">.</span>parent()<span style="color:#f92672">.</span>gen()

    <span style="color:#75715e"># compute polynomials</span>
    gg <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> ii <span style="color:#f92672">in</span> range(mm):
        <span style="color:#66d9ef">for</span> jj <span style="color:#f92672">in</span> range(dd):
            gg<span style="color:#f92672">.</span>append((x <span style="color:#f92672">*</span> XX)<span style="color:#f92672">**</span>jj <span style="color:#f92672">*</span> N<span style="color:#f92672">**</span>(mm <span style="color:#f92672">-</span> ii) <span style="color:#f92672">*</span> polZ(x <span style="color:#f92672">*</span> XX)<span style="color:#f92672">**</span>ii)
    <span style="color:#66d9ef">for</span> ii <span style="color:#f92672">in</span> range(tt):
        gg<span style="color:#f92672">.</span>append((x <span style="color:#f92672">*</span> XX)<span style="color:#f92672">**</span>ii <span style="color:#f92672">*</span> polZ(x <span style="color:#f92672">*</span> XX)<span style="color:#f92672">**</span>mm)
    
    <span style="color:#75715e"># construct lattice B</span>
    BB <span style="color:#f92672">=</span> Matrix(ZZ, nn)
    
    <span style="color:#66d9ef">for</span> ii <span style="color:#f92672">in</span> range(nn):
        <span style="color:#66d9ef">for</span> jj <span style="color:#f92672">in</span> range(ii<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
            BB[ii, jj] <span style="color:#f92672">=</span> gg[ii][jj]

    <span style="color:#75715e"># LLL</span>
    BB <span style="color:#f92672">=</span> BB<span style="color:#f92672">.</span>LLL(early_red<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, use_siegel<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)

    <span style="color:#75715e"># transform shortest vector in polynomial    </span>
    new_pol <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> ii <span style="color:#f92672">in</span> range(nn):
        new_pol <span style="color:#f92672">+=</span> x<span style="color:#f92672">**</span>ii <span style="color:#f92672">*</span> BB[<span style="color:#ae81ff">0</span>, ii] <span style="color:#f92672">/</span> XX<span style="color:#f92672">**</span>ii

    <span style="color:#75715e"># factor polynomial</span>
    potential_roots <span style="color:#f92672">=</span> new_pol<span style="color:#f92672">.</span>roots()

    <span style="color:#66d9ef">return</span> [i[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> potential_roots]

<span style="color:#75715e"># Top level of the attack, feeds the queue for the workers</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">roca</span>(N):
  
  <span style="color:#75715e"># Key is not always of perfect size, infer from size</span>
  keylength <span style="color:#f92672">=</span> int(log(N, <span style="color:#ae81ff">2</span>))
  <span style="color:#66d9ef">if</span> keylength <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span> :
    keylength <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
  <span style="color:#66d9ef">elif</span>  keylength <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2000</span> :
    keylength <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> 
  <span style="color:#66d9ef">elif</span> keylength <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4000</span> :
    keylength <span style="color:#f92672">=</span> <span style="color:#ae81ff">2048</span> 
  <span style="color:#66d9ef">else</span>:
    keylength <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span> 
  
  <span style="color:#75715e"># bruteforce</span>
  M_prime <span style="color:#f92672">=</span> param[keylength][<span style="color:#e6db74">&#39;M_prime&#39;</span>]
  c_prime <span style="color:#f92672">=</span> discrete_log(N, Mod(<span style="color:#ae81ff">65537</span>, M_prime))
  ord_prime <span style="color:#f92672">=</span> Zmod(M_prime)(<span style="color:#ae81ff">65537</span>)<span style="color:#f92672">.</span>multiplicative_order()
  top <span style="color:#f92672">=</span> (c_prime <span style="color:#f92672">+</span> ord_prime)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
  beta <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span> 
  mm <span style="color:#f92672">=</span> param[keylength][<span style="color:#e6db74">&#39;m&#39;</span>]
  tt <span style="color:#f92672">=</span> param[keylength][<span style="color:#e6db74">&#39;t&#39;</span>]

  XX <span style="color:#f92672">=</span> int((<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>pow(N, beta)) <span style="color:#f92672">/</span> M_prime) 

  <span style="color:#75715e"># Bruteforce until p, q are found</span>
  a_prime <span style="color:#f92672">=</span> floor(c_prime<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)
  <span style="color:#66d9ef">while</span> a_prime <span style="color:#f92672">&lt;</span> top:
      
      <span style="color:#75715e"># Construct polynomial</span>
      m_inv <span style="color:#f92672">=</span> int(inverse_mod(M_prime, N))
      k_tmp <span style="color:#f92672">=</span> int(pow(<span style="color:#ae81ff">65537</span>, a_prime, M_prime))
      known_part_pol <span style="color:#f92672">=</span> int(k_tmp <span style="color:#f92672">*</span> m_inv)
      F <span style="color:#f92672">=</span> PolynomialRing(Zmod(N), implementation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NTL&#39;</span>, names<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;x&#39;</span>,))
      (x,) <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>_first_ngens(<span style="color:#ae81ff">1</span>)
      pol <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> known_part_pol
      
      <span style="color:#75715e"># Get roots of polynomial using coppersmith</span>
      roots <span style="color:#f92672">=</span> coppersmith_howgrave_univariate(pol, N, beta, mm, tt, XX)
     
      <span style="color:#75715e"># Check if roots are p, q</span>
      <span style="color:#66d9ef">for</span> root <span style="color:#f92672">in</span> roots:
        factor1 <span style="color:#f92672">=</span> k_tmp <span style="color:#f92672">+</span> abs(root) <span style="color:#f92672">*</span> M_prime
        <span style="color:#66d9ef">if</span> mod(N, factor1) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
          factor2 <span style="color:#f92672">=</span> N <span style="color:#f92672">//</span> factor1
          <span style="color:#66d9ef">return</span> int(factor1), int(factor2)
      a_prime <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

<span style="color:#f92672">from</span> Crypto.Util.number <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">from</span> Crypto.PublicKey <span style="color:#f92672">import</span> RSA
<span style="color:#f92672">import</span> base64

<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;./pub.pem&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
    key <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>import_key(f<span style="color:#f92672">.</span>read())
    e <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>e
    n <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>n
print(n)
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;flag.enc&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
    c <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(f<span style="color:#f92672">.</span>read())

N <span style="color:#f92672">=</span> n
print (<span style="color:#e6db74">&#34;[+] Factoring </span><span style="color:#e6db74">%i</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> N)

factor1, factor2 <span style="color:#f92672">=</span> roca(N)
q <span style="color:#f92672">=</span> factor1
p <span style="color:#f92672">=</span> factor2

print (<span style="color:#e6db74">&#34;[+] Found factors of N:&#34;</span>)
print (<span style="color:#e6db74">&#34;[+] p =&#34;</span> , factor1)
print (<span style="color:#e6db74">&#34;[+] q =&#34;</span> , factor2)

<span style="color:#66d9ef">assert</span>(p <span style="color:#f92672">*</span> q <span style="color:#f92672">==</span> n)
d <span style="color:#f92672">=</span> inverse(e, (q <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> (p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))
c <span style="color:#f92672">=</span> bytes_to_long(bytes<span style="color:#f92672">.</span>fromhex(str(c)[<span style="color:#ae81ff">2</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
print(long_to_bytes(pow(c, d, n)))
</code></pre></div><p>使用sagemath运行得到flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{760958c9-cca9-458b-9cbe-ea07aa1668e4}
</code></pre></div><h2 id="参考">参考：</h2>
<ol>
<li><a href="https://www.cnblogs.com/cc11001100/p/9357263.html#:~:text=%E5%BD%93%E9%93%BA%E5%AF%86%E7%A0%81%E6%98%AF%E4%B8%80%E7%A7%8D%E5%BE%88,%E5%8A%A0%E5%AF%86%E5%90%8E%E7%9A%84%E5%AF%86%E6%96%87%E4%B8%AD%E3%80%82">当铺密码-博客园</a></li>
<li><a href="https://blog.chrisyy.top/2020/05/24/gkctf/">GKCTF2020 Crypto Writeup- Chrisyy&rsquo;s blog</a></li>
</ol>

    <h4><a href="https://OolongCode.github.io">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>
    <a href="https://gitlab.com/maxlefou/hugo.386">hugo.386 theme by Max le Fou</a> | 

&copy; 
<a href="http://jmf-portfolio.netlify.com" target="_blank">
    JM Fergeau
</a>
<span id="thisyear">2022</span>

    | Example site


</p>
    <p class="text-center">
        
        
        <a href="https://linkedin.com">Linkedin</a> 
        <a href="https://github.com/OolongCode">GitHub</a> 
        <a href="https://gitlab.com">GitLab</a>
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: false ,
        onePass: false , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></html>
